<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive File Manager</title>
    
    <!-- FIX 1: Load Tailwind CDN FIRST -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FIX 1: Tailwind Configuration Script SECOND (Now 'tailwind' is defined) -->
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <style>
        /* Custom scrollbar for file list */
        .file-list::-webkit-scrollbar {
            width: 6px;
        }
        .file-list::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 3px;
        }
        .dark .file-list::-webkit-scrollbar-thumb {
            background-color: #4b5563;
        }
        /* Style for the built-in console */
        .activity-log {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            background-color: #1f2937; /* Dark background (fixed for high contrast) */
            color: #d1d5db; /* Light gray text */
            max-height: 250px;
            overflow-y: auto;
            border-radius: 0.5rem;
        }
        .log-item {
            padding: 4px 8px;
            border-bottom: 1px solid #374151;
            font-size: 0.8rem;
        }
        .log-item:last-child {
            border-bottom: none;
        }
        .log-error { color: #f87171; } /* Red for errors */
        .log-success { color: #34d399; } /* Green for success */
        .log-info { color: #93c5fd; } /* Blue for info */
    </style>
</head>
<!-- Apply background classes that respond to the dark mode class -->
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen p-4 sm:p-8 font-sans flex justify-center">

    <div class="max-w-4xl w-full bg-white dark:bg-gray-800 shadow-2xl dark:shadow-xl dark:border dark:border-gray-700 rounded-xl p-6 md:p-10 space-y-10 transition-colors duration-300">

        <!-- Header and Theme Switcher -->
        <header class="text-center relative">
            <h1 class="text-4xl font-extrabold text-indigo-700 dark:text-indigo-400">Secure Drive File Uploader</h1>
            <p class="text-gray-500 dark:text-gray-400 mt-2">Frontend hosted on GitHub Pages, secure backend via Google Apps Script.</p>
            
            <!-- Theme Toggle Button -->
            <button id="themeToggle" class="absolute top-0 right-0 p-2 text-gray-700 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 transition duration-300 rounded-full">
                <!-- Sun Icon (Default/Light Mode) -->
                <svg id="sunIcon" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <!-- Moon Icon (Dark Mode) -->
                <svg id="moonIcon" class="w-6 h-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </header>

        <!-- Upload Section -->
        <section class="p-6 border border-indigo-200 dark:border-indigo-700 rounded-xl bg-indigo-50 dark:bg-gray-700 shadow-inner transition-colors duration-300">
            <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-400 mb-4">Upload File</h2>
            <form id="uploadForm" class="space-y-4">
                <div>
                    <label for="fileInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select File</label>
                    <input type="file" id="fileInput" required class="block w-full text-sm text-gray-500 dark:text-gray-400
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-indigo-100 dark:file:bg-indigo-600 file:text-indigo-700 dark:file:text-white
                        hover:file:bg-indigo-200 dark:hover:file:bg-indigo-700 cursor-pointer"
                    />
                </div>
                <button type="submit" id="uploadButton"
                    class="w-full sm:w-auto px-8 py-3 bg-indigo-600 dark:bg-indigo-500 text-white font-bold rounded-full shadow-lg hover:bg-indigo-700 dark:hover:bg-indigo-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.02]">
                    Upload to Drive
                </button>
            </form>
            <div id="uploadMessage" class="mt-4 p-3 rounded-lg text-sm hidden" role="alert"></div>
        </section>

        <!-- Folder Contents Section -->
        <section class="p-6 border border-gray-200 dark:border-gray-700 rounded-xl shadow-md transition-colors duration-300">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200">Folder Contents</h2>
                <button id="refreshButton"
                    class="flex items-center space-x-2 px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition duration-300 disabled:opacity-50">
                    <svg id="refreshIcon" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.995 8.995 0 0115 13H9m4-12H9.582M20 20v-5h-.582m0 0a8.995 8.995 0 01-5 1.776M9 13h6m-3 3v-6" />
                    </svg>
                    <span>Refresh List</span>
                </button>
            </div>

            <div id="fileListContainer" class="file-list max-h-96 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-lg p-4 bg-gray-50 dark:bg-gray-700/50">
                <p id="loadingList" class="text-center text-gray-500 dark:text-gray-400 py-4">Loading file list...</p>
                <ul id="fileList" class="space-y-3">
                    <!-- File items will be inserted here -->
                </ul>
            </div>
            <div id="listMessage" class="mt-4 p-3 rounded-lg text-sm hidden" role="alert"></div>
        </section>

        <!-- Built-in Console (Activity Log) -->
        <section class="p-6 border border-gray-300 dark:border-gray-700 rounded-xl bg-gray-700 dark:bg-gray-900 shadow-xl">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-semibold text-gray-100">Activity Log (Console)</h2>
                <button id="clearConsoleButton" class="px-3 py-1 bg-gray-600 text-xs text-gray-200 rounded hover:bg-gray-500 transition duration-150">
                    Clear Log
                </button>
            </div>
            <div id="activityLog" class="activity-log p-2">
                <div class="log-item log-info">App initialized. Ready for API calls.</div>
            </div>
        </section>

    </div>

    <script>
        // --- GOOGLE APPS SCRIPT WEB APP URL (IMPORTANT: DO NOT CHANGE THIS URL) ---
        // This must be the /exec URL of your deployed Web App, not the /edit URL.
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbw0BUrVKuZd1a_2PuWiwrpGjE6ks4vj1VISW6gnQwx_JtyEU3TGFMkpdHW2pFBt6RWE/exec'; 
        
        const DRIVE_FOLDER_ID = '1KUaOHK5iALhZjxOG4YTUqYTU5_lDR1tM';
        const activityLogEl = document.getElementById('activityLog');
        const htmlEl = document.documentElement;
        const themeToggleBtn = document.getElementById('themeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');


        // --- Theme Switching Logic ---

        function loadTheme() {
            // Check for theme preference in localStorage, default to 'light'
            const theme = localStorage.getItem('theme') || 'light';
            
            if (theme === 'dark') {
                htmlEl.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                htmlEl.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        }

        function toggleTheme() {
            if (htmlEl.classList.contains('dark')) {
                // Switch to light mode
                htmlEl.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                logToConsole('Switched to Light Mode', 'info');
            } else {
                // Switch to dark mode
                htmlEl.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                logToConsole('Switched to Dark Mode', 'info');
            }
        }

        // Attach event listener to the toggle button
        themeToggleBtn.addEventListener('click', toggleTheme);
        

        // --- Console/Logging Function ---

        /**
         * Logs messages to the built-in console.
         * @param {string} message - The message content.
         * @param {string} type - 'info', 'success', or 'error'.
         */
        function logToConsole(message, type = 'info') {
            const now = new Date();
            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            const item = document.createElement('div');
            item.className = `log-item log-${type}`;
            item.innerHTML = `[${time}] &mdash; ${message}`;
            
            // Prepend new item to the top
            if (activityLogEl.firstChild) {
                activityLogEl.insertBefore(item, activityLogEl.firstChild);
            } else {
                activityLogEl.appendChild(item);
            }
            
            // Maintain scroll position (optional: scroll to top for newest message)
            activityLogEl.scrollTop = 0; 
        }

        document.getElementById('clearConsoleButton').addEventListener('click', () => {
            activityLogEl.innerHTML = '<div class="log-item log-info">Activity Log Cleared.</div>';
        });

        // --- Utility Functions ---

        /**
         * Shows a message in the UI with a specific style.
         * @param {string} elementId - The ID of the message container div.
         * @param {string} message - The message text.
         * @param {string} type - 'success' or 'error'.
         */
        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            // Removed dark mode classes from here as the body/container handles the general styling
            el.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (type === 'success') {
                el.classList.add('bg-green-100', 'text-green-700');
            } else {
                el.classList.add('bg-red-100', 'text-red-700');
            }
        }

        /**
         * Formats file size in bytes into human-readable format.
         * @param {number} bytes
         * @returns {string}
         */
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // --- Upload Logic ---

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const uploadButton = document.getElementById('uploadButton');
            const messageEl = document.getElementById('uploadMessage');

            if (!file) {
                showMessage('uploadMessage', 'Please select a file to upload.', 'error');
                logToConsole('Upload failed: No file selected.', 'error');
                return;
            }

            // Prepare for upload
            uploadButton.disabled = true;
            uploadButton.textContent = 'Uploading...';
            messageEl.classList.add('hidden');

            // Log request
            logToConsole(`Preparing to upload file: ${file.name} (${formatBytes(file.size)})`, 'info');
            logToConsole(`API POST Request to: ${GAS_API_URL}`, 'info');

            const formData = new FormData();
            formData.append('file', file, file.name);

            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.message && result.message.includes('successfully')) {
                        showMessage('uploadMessage', `Success! File uploaded: ${result.fileName}`, 'success');
                        logToConsole(`Upload successful. Drive File ID: ${result.fileId}`, 'success');
                        fetchFileList();
                    } else {
                        logToConsole(`Upload failed. API Response: ${JSON.stringify(result)}`, 'error');
                         throw new Error(`Upload failed. Details: ${result.message || 'Check console for details.'}`);
                    }
                } else {
                    const text = await response.text();
                    logToConsole(`API Error Status: ${response.status}`, 'error');
                    logToConsole(`Raw API Response: ${text.substring(0, 200)}...`, 'error');
                    throw new Error(`Server returned status ${response.status}. See Activity Log.`);
                }
            } catch (error) {
                // Use the error message directly if it's a Fetch error (like "Failed to fetch")
                logToConsole(`FATAL UPLOAD ERROR: ${error.message}`, 'error');
                showMessage('uploadMessage', `Error during upload: ${error.message || 'Check Activity Log for details.'}`, 'error');
            } finally {
                uploadButton.disabled = false;
                uploadButton.textContent = 'Upload to Drive';
                fileInput.value = '';
            }
        });

        // --- List/Fetch Logic ---

        async function fetchFileList() {
            const listEl = document.getElementById('fileList');
            const loadingEl = document.getElementById('loadingList');
            const refreshButton = document.getElementById('refreshButton');
            const listMessageEl = document.getElementById('listMessage');

            listEl.innerHTML = '';
            listMessageEl.classList.add('hidden');
            loadingEl.classList.remove('hidden');
            refreshButton.disabled = true;
            listEl.classList.add('opacity-50');
            
            const listUrl = `${GAS_API_URL}?action=listFiles`;
            logToConsole(`API GET Request to: ${listUrl}`, 'info');

            try {
                const response = await fetch(listUrl, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                });

                if (!response.ok) {
                    // Check if the response is successful, even if fetching the content later fails.
                    throw new Error(`Failed to fetch list. Server status: ${response.status}`);
                }

                const result = await response.json();
                const files = result.files || [];
                
                logToConsole(`List received. Found ${files.length} files.`, 'success');

                if (files.length === 0) {
                    listEl.innerHTML = '<li class="text-center text-gray-500 py-4 dark:text-gray-400">This folder is currently empty.</li>';
                } else {
                    files.forEach(file => {
                        const listItem = document.createElement('li');
                        let icon = 'üì¶';
                        if (file.mimeType.includes('image')) { icon = 'üñºÔ∏è'; }
                        else if (file.mimeType.includes('pdf')) { icon = 'üìÑ'; }
                        else if (file.mimeType.includes('spreadsheet')) { icon = 'üìä'; }
                        else if (file.mimeType.includes('document')) { icon = '‚úçÔ∏è'; }

                        // Apply dark mode classes to list items
                        listItem.className = 'flex items-center justify-between p-3 bg-white dark:bg-gray-700 border border-gray-100 dark:border-gray-600 rounded-lg hover:shadow-md dark:hover:shadow-lg dark:shadow-gray-900 transition duration-150';
                        listItem.innerHTML = `
                            <div class="flex items-center space-x-3 min-w-0">
                                <span class="text-xl flex-shrink-0">${icon}</span>
                                <div class="min-w-0">
                                    <p class="font-medium text-gray-900 dark:text-gray-200 truncate">${file.name}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${new Date(file.createdTime).toLocaleDateString()} &middot; ${formatBytes(file.size)}</p>
                                </div>
                            </div>
                            <a href="${file.webViewLink}" target="_blank" rel="noopener noreferrer" class="flex-shrink-0 text-indigo-500 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 text-sm font-medium">
                                View
                            </a>
                        `;
                        listEl.appendChild(listItem);
                    });
                }
            } catch (error) {
                logToConsole(`FATAL LIST ERROR: ${error.message}`, 'error');
                showMessage('listMessage', `Failed to load file list. Error: ${error.message}`, 'error');
                listEl.innerHTML = '<li class="text-center text-red-500 py-4 dark:text-red-400">Error loading data. See Activity Log.</li>';
            } finally {
                loadingEl.classList.add('hidden');
                refreshButton.disabled = false;
                listEl.classList.remove('opacity-50');
            }
        }

        document.getElementById('refreshButton').addEventListener('click', fetchFileList);

        // Initial calls when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme(); // Load theme from local storage first
            fetchFileList(); // Then fetch the file list
        });
    </script>
</body>
</html>
